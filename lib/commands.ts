import { App, TFile } from "obsidian";
import { NextNoteSuggestModal } from "./NextNoteSuggestModal";
import { getActiveFile, getPreviousNote, getNextNotes, detachNote, setPreviousProperty, findLastNote, findFirstNote } from "./obsidian";

export async function goToPreviousNoteCommand(app: App) {
    const file = getActiveFile(app);
    if (!file) {
        return;
    }

    const target = getPreviousNote(app, file);
    if (!target) {
        return;
    }

    await app.workspace.getLeaf().openFile(target);
}

export async function goToNextNoteCommand(app: App) {
    const file = getActiveFile(app);
    if (!file) {
        return;
    }

    const nextNotes = getNextNotes(app, file);

    if (nextNotes.length === 0) {
        return;
    }

    if (nextNotes.length === 1) {
        // If only one candidate exists, open it directly.
        await app.workspace.getLeaf().openFile(nextNotes[0]);
    } else {
        // If multiple candidates exist, open a suggestion modal.
        new NextNoteSuggestModal(app, nextNotes, (selectedFile) => {
            void app.workspace.getLeaf().openFile(selectedFile);
        }).open();
    }
}

export async function goToFirstNoteCommand(app: App) {
    const file = getActiveFile(app);
    if (!file) {
        return;
    }

    const firstNote = await findFirstNote(app, file);
    if (firstNote !== file) {
        await app.workspace.getLeaf().openFile(firstNote);
    }
}

export async function goToLastNoteCommand(app: App) {
    const file = getActiveFile(app);
    if (!file) {
        return;
    }

    const lastNote = await findLastNote(app, file);
    if (lastNote && lastNote !== file) {
        await app.workspace.getLeaf().openFile(lastNote);
    }
}

export async function detachNoteCommand(app: App) {
    const file = getActiveFile(app);
    if (!file) {
        return;
    }

    // TODO: Add confirm dialog
    await detachNote(app, file);
}

export async function insertNoteToLastCommand(app: App) {
    const file = getActiveFile(app);
    if (!file) {
        return;
    }

    const selectedNote = await new Promise<TFile | null>((resolve) => {
        new NextNoteSuggestModal(app, app.vault.getMarkdownFiles(), resolve).open();
    });

    if (!selectedNote) {
        return;
    }

    await detachNote(app, file);

    const lastNote = await findLastNote(app, selectedNote);
    if (!lastNote) {
        return;
    }

    await setPreviousProperty(app, file, lastNote.basename);
}

export async function insertNoteCommand(app: App) {
    const file = getActiveFile(app);
    if (!file) {
        return;
    }

    // 1. Select target note
    const selectedNote = await new Promise<TFile | null>((resolve) => {
        // Show all markdown files
        new NextNoteSuggestModal(app, app.vault.getMarkdownFiles(), resolve).open();
    });

    if (!selectedNote) {
        return;
    }

    // 2. Detach current note
    await detachNote(app, file);

    // 3. Find successors of the target note (notes that currently point to target)
    const successors = getNextNotes(app, selectedNote);

    // 4. Link current note to target
    await setPreviousProperty(app, file, selectedNote.basename);

    // 5. Update successors to point to current note
    for (const successor of successors) {
        await setPreviousProperty(app, successor, file.basename);
    }
}

export async function insertNoteToFirstCommand(app: App) {
    const file = getActiveFile(app);
    if (!file) {
        return;
    }

    // 1. Select target note
    const selectedNote = await new Promise<TFile | null>((resolve) => {
        new NextNoteSuggestModal(app, app.vault.getMarkdownFiles(), resolve).open();
    });

    if (!selectedNote) {
        return;
    }

    // 2. Detach current note
    await detachNote(app, file);

    // 3. Find first note of the chain
    const firstNote = await findFirstNote(app, selectedNote);

    // 4. Update first note to point to current note
    await setPreviousProperty(app, firstNote, file.basename);

    // 5. Update current note to point to ROOT
    await app.fileManager.processFrontMatter(file, (fm) => {
        fm.previous = "ROOT";
    });
}
